<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>MicroDiab - Patient Details</title>
    <link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/5.0.0/css/bootstrap.min.css}"/>
</head>

<body class="d-flex flex-column vh-100">

<!-- Header -->
<th:block th:replace="~{fragments :: header}"></th:block>

<!-- Main body -->
<main class="flex-grow-1 py-4">
    <div class="container mt-4">
        <!-- Main title -->
        <div class="row mb-4">
            <h1 class="text-center">
                Patient folder id =
                <span th:text="${patient.id}" class="text-danger"></span>
            </h1>
        </div>

        <!-- Block for displaying global errors -->
        <div th:if="${error}" class="alert alert-danger" role="alert">
            <p th:text="${error}">An error has occurred.</p>
        </div>

        <!-- Block to display successes -->
        <div th:if="${success}" class="alert alert-success" role="alert">
            <p th:text="${success}">Success - nice...</p>
        </div>

        <!-- Section: Patient information -->
        <div class="row mb-4">
            <h2>Patient Information</h2>
            <form th:action="@{/update/{id}/updatepatient(id=${id})}" th:object="${patient}" method="post" class="w-100">
                <!-- Form fields -->
                <div class="mb-3 row">
                    <label for="lastname" class="col-sm-2 col-form-label">Lastname</label>
                    <div class="col-sm-10">
                        <input type="text" th:field="*{lastname}" id="lastname" placeholder="Lastname" class="form-control w-50">
                        <span th:if="${errors != null && errors.containsKey('lastname')}" class="text-danger" th:text="${errors['lastname']}"></span>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="firstname" class="col-sm-2 col-form-label">Firstname</label>
                    <div class="col-sm-10">
                        <input type="text" th:field="*{firstname}" id="firstname" placeholder="Firstname" class="form-control w-50">
                        <span th:if="${errors != null && errors.containsKey('firstname')}" class="text-danger" th:text="${errors['firstname']}"></span>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="dateofbirth" class="col-sm-2 col-form-label">Date of Birth</label>
                    <div class="col-sm-10">
                        <input type="date" th:field="*{dateofbirth}" id="dateofbirth" class="form-control w-50">
                        <span th:if="${errors != null && errors.containsKey('dateofbirth')}" class="text-danger" th:text="${errors['dateofbirth']}"></span>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="gender" class="col-sm-2 col-form-label">Gender</label>
                    <div class="col-sm-10">
                        <select th:field="*{gender}" id="gender" class="form-select w-50">
                            <option value="" disabled selected>Select gender</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                        </select>
                        <span th:if="${errors != null && errors.containsKey('gender')}" class="text-danger" th:text="${errors['gender']}"></span>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="address" class="col-sm-2 col-form-label">Address</label>
                    <div class="col-sm-10">
                        <input type="text" th:field="*{address}" id="address" placeholder="Address" class="form-control w-50">
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="phone" class="col-sm-2 col-form-label">Phone</label>
                    <div class="col-sm-10">
                        <input type="text" th:field="*{phone}" id="phone" placeholder="Phone" class="form-control w-50">
                    </div>
                </div>

                <!-- Buttons -->
                <div class="mb-3 row">
                    <div class="col-sm-12 d-flex gap-2">
                        <!-- Hidden field for patId -->
                        <input type="hidden" name="id" th:value="${patient.id}">
                        <input class="btn btn-primary" type="submit" value="Update">
                    </div>
                </div>
            </form>
        </div>

        <!-- Section: Risk Level -->
        <div class="row mt-4">
            <h2>Risk Level</h2>
            <div class="card">
                <div class="card-body">
                    <div class="mb-3 row">
                        <label for="riskLevel" class="col-sm-2 col-form-label">Current Risk Level</label>
                        <div class="col-sm-10">
                            <input type="text" id="riskLevel" class="form-control w-50" th:value="${riskLevel}" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section : Notes -->
        <div class="row mt-4">
            <h2>Notes</h2>

            <!-- Subsection : Add a note -->
            <div class="mb-4">
                <h4>Add Note</h4>
                <form th:action="@{/update/{id}/addnotes(id=${patient.id})}" th:object="${newNote}" method="post">
                    <!-- Hidden field for patId -->
                    <input type="hidden" th:field="*{patId}" />
                    <!-- Hidden field for patient -->
                    <input type="hidden" th:field="*{patient}" />
                    <div class="mb-3 row">
                        <div class="col-sm-10">
                            <textarea class="form-control w-100" th:field="*{note}" rows="3" placeholder="Enter note here..."></textarea>
                            <span th:if="${errors != null && errors.containsKey('note')}" class="text-danger" th:text="${errors['note']}"></span>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <div class="col-sm-10">
                            <button type="submit" class="btn btn-primary">Save Note</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Subsection: Previous notes -->
            <div>
                <h4>Previous Notes</h4>
                <div th:if="${not #lists.isEmpty(notes)}">
                    <ul class="list-group w-100">
                        <li th:each="note : ${notes}" class="list-group-item" style="white-space: pre-line;" th:text="'Undefined Date - ' + ${note.note}"></li>
                    </ul>
                </div>
                <div th:if="${#lists.isEmpty(notes)}" class="alert alert-info w-50">
                    No notes available for this patient.
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<th:block th:replace="~{fragments :: footer}"></th:block>

<script type="text/javascript" th:src="@{/webjars/bootstrap/5.0.0/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
